import {
    Button,
    VerticalBox,
    GroupBox,
    CheckBox,
    ListView,
    HorizontalBox,
    LineEdit,
    ScrollView,
    StandardListView,
} from "std-widgets.slint";
import "../font/NotoSansSC-Regular.ttf";

export component AppWindow inherits Window {
    default-font-family: "Noto Sans SC";
    title: "File Cleaner";
    width: 900px;
    height: 700px;

    in-out property <string> selected_directory;
    in-out property <bool> org_enabled;
    in-out property <bool> html_enabled;
    in-out property <bool> dsstore_enabled;
    in-out property <string> action_text;
    in-out property <[string]> scan_results;

    // è·¯å¾„ä¸æ–‡ä»¶å¤¹é€»è¾‘
    in-out property <[string]> current_path_parts;
    in-out property <[string]> folder_list;
    
    // [æ–°å¢] æ§åˆ¶å¼¹çª—æ˜¾ç¤ºçš„å˜é‡
    in-out property <bool> show_confirm_dialog: false;

    callback choose_dir();
    callback action_clicked();
    callback path_part_clicked(int);
    callback folder_clicked(string);

    // [ä¿®æ”¹] ä½¿ç”¨ Rectangle ä½œä¸ºæ ¹å®¹å™¨ï¼Œä»¥ä¾¿å®ç°å›¾å±‚å åŠ ï¼ˆMain UI + å¼¹çª—ï¼‰
    Rectangle {
        
        // --- å›¾å±‚ 1: ä¸»ç•Œé¢ ---
        VerticalBox {
            padding: 16px;
            spacing: 16px;

            // 1. é¡¶éƒ¨å¯¼èˆªåŒºåŸŸ
            GroupBox {
                title: "Current Location";
                vertical-stretch: 0;

                HorizontalBox {
                    padding: 4px;
                    alignment: start;
                    spacing: 4px;
                    for path_part[i] in current_path_parts: Button {
                        text: path_part;
                        height: 28px;
                        clicked => {
                            path_part_clicked(i);
                        }
                    }
                }
            }

            // 2. ä¸­é—´å†…å®¹åŒºåŸŸ
            HorizontalBox {
                spacing: 16px;
                vertical-stretch: 1;

                // å·¦ä¾§ï¼šç›®å½•é€‰æ‹©
                GroupBox {
                    title: "Select Directory";
                    horizontal-stretch: 1;
                    vertical-stretch: 1;

                    ListView {
                        for item in folder_list: Rectangle {
                            height: 30px;
                            width: parent.width;
                            background: area.pressed ? #d0d0d0 : (area.has-hover ? #e8e8e8 : transparent);
                            border-radius: 4px;

                            area := TouchArea {
                                clicked => {
                                    root.folder_clicked(item);
                                }
                            }

                            Text {
                                text: "ğŸ“ " + item;
                                color: #222222;
                                font-size: 14px;
                                x: 8px;
                                vertical-alignment: center;
                                overflow: elide;
                                width: parent.width - 16px;
                            }
                        }
                    }
                }

                // å³ä¾§ï¼šæ‰«æç»“æœ
                GroupBox {
                    title: "Scan Results (" + scan_results.length + " items)";
                    horizontal-stretch: 2;
                    vertical-stretch: 1;

                    ListView {
                        for item[i] in scan_results: Rectangle {
                            height: 26px;
                            width: parent.width;
                            background: Math.mod(i, 2) == 0 ? #ffffff : #f9f9f9;
                            Text {
                                text: item;
                                color: #555555;
                                font-size: 12px;
                                x: 8px;
                                vertical-alignment: center;
                                overflow: elide;
                                width: parent.width - 16px;
                            }
                        }
                    }
                }
            }

            // 3. åº•éƒ¨æ§åˆ¶æ 
            GroupBox {
                title: "Settings & Actions";
                vertical-stretch: 0;

                HorizontalBox {
                    spacing: 20px;
                    padding: 8px;
                    alignment: center;

                    HorizontalBox {
                        spacing: 10px;
                        CheckBox {
                            text: "*.org~";
                            checked <=> root.org_enabled;
                            toggled => {
                                root.action_text = "Scan"
                            }
                        }

                        CheckBox {
                            text: "*.html~";
                            checked <=> root.html_enabled;
                            toggled => {
                                root.action_text = "Scan"
                            }
                        }

                        CheckBox {
                            text: ".DS_Store";
                            checked <=> root.dsstore_enabled;
                            toggled => {
                                root.action_text = "Scan"
                            }
                        }
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: root.action_text;
                        width: 120px;
                        height: 36px;
                        primary: true;
                        // [ä¿®æ”¹] æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæ˜¯ Cleanï¼Œå…ˆå¼¹çª—ï¼›å¦åˆ™ç›´æ¥æ‰§è¡Œ
                        clicked => {
                            if (root.action_text == "Clean") {
                                root.show_confirm_dialog = true;
                            } else {
                                root.action_clicked();
                            }
                        }
                    }
                }
            }
        }

        // --- å›¾å±‚ 2: ç¡®è®¤å¼¹çª— (é®ç½©å±‚) ---
        // åªæœ‰å½“ show_confirm_dialog ä¸º true æ—¶æ‰æ¸²æŸ“
        if root.show_confirm_dialog: Rectangle {
            width: 100%;
            height: 100%;
            background: #00000088; // åŠé€æ˜é»‘è‰²é®ç½©

            // æ‹¦æˆªç‚¹å‡»ï¼Œé˜²æ­¢ç‚¹ç©¿åˆ°åº•éƒ¨ UI
            TouchArea { }

            // å¼¹çª—ä¸»ä½“
            Rectangle {
                width: 300px;
                height: 160px;
                background: white;
                border-radius: 8px;
                // ç®€å•çš„é˜´å½±æ¨¡æ‹Ÿ
                border-width: 1px;
                border-color: #aaaaaa;

                VerticalBox {
                    padding: 20px;
                    spacing: 20px;
                    alignment: center;

                    // æç¤ºæ–‡å­—
                    Text {
                        text: "âš ï¸ Warning";
                        font-size: 18px;
                        font-weight: 700;
                        color: #d32f2f; // çº¢è‰²è­¦å‘Š
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "Permanently delete " + root.scan_results.length + " files?";
                        font-size: 14px;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                    }

                    // æŒ‰é’®ç»„
                    HorizontalBox {
                        spacing: 20px;
                        alignment: center;

                        Button {
                            text: "Cancel";
                            width: 100px;
                            clicked => {
                                root.show_confirm_dialog = false;
                            }
                        }

                        Button {
                            text: "Confirm";
                            width: 100px;
                            primary: true;
                            clicked => {
                                root.show_confirm_dialog = false;
                                // ç”¨æˆ·ç¡®è®¤åï¼Œæ‰çœŸæ­£è°ƒç”¨ Rust é€»è¾‘
                                root.action_clicked();
                            }
                        }
                    }
                }
            }
        }
    }
}
