import {
    Button,
    VerticalBox,
    GroupBox,
    CheckBox,
    ListView,
    HorizontalBox,
    LineEdit,
    ScrollView,
    StandardListView,
} from "std-widgets.slint";
import "../font/NotoSansSC-Regular.ttf";

export component AppWindow inherits Window {
    default-font-family: "Noto Sans SC";
    title: "File Cleaner";
    width: 900px;
    height: 700px;

    // æ–‡ä»¶ç±»å‹å¤šé€‰æ¡†çŠ¶ä½“å±æ€§
    in-out property <bool> org_enabled;
    in-out property <bool> html_enabled;
    in-out property <bool> dsstore_enabled;

    // æ˜¯å¦æ­£åœ¨å¤„ç†ï¼ˆæ‰«ææˆ–æ¸…ç†ä¸­ï¼‰ï¼Œç”¨äºç¦ç”¨äº¤äº’
    in-out property <bool> is_processing: false;

    // æ‰«æ/æ¸…ç†æŒ‰é’®
    in-out property <string> action_text;

    // åº•éƒ¨çŠ¶æ€æ ä¿¡æ¯
    in-out property <string> status_message: "å°±ç»ª"; 

    // æ‰«æç»“æœ
    in-out property <[string]> scan_results;

    // è·¯å¾„ä¸æ–‡ä»¶å¤¹é€»è¾‘
    in-out property <[string]> current_path_parts;
    in-out property <[string]> folder_list;
    
    // æ§åˆ¶å¼¹çª—æ˜¾ç¤ºçš„å˜é‡
    in-out property <bool> show_confirm_dialog: false;

    callback choose_dir();
    callback action_clicked();
    callback path_part_clicked(int);
    callback folder_clicked(string);

    // ä½¿ç”¨ Rectangle ä½œä¸ºæ ¹å®¹å™¨ï¼Œä»¥ä¾¿å®ç°å›¾å±‚å åŠ ï¼ˆMain UI + å¼¹çª—ï¼‰
    Rectangle {
        
        // --- å›¾å±‚ 1: ä¸»ç•Œé¢ ---
        VerticalBox {
            padding: 16px;
            spacing: 12px;

            // 1. é¡¶éƒ¨å¯¼èˆªåŒºåŸŸ
            GroupBox {
                title: "å½“å‰è·¯å¾„";
                vertical-stretch: 0;

                Rectangle {
                    background: white;
                    border-radius: 4px;
                    border-color: #cccccc;
                    border-width: 1px;
                    height: 36px;
                    HorizontalBox {
                        padding: 4px;
                        alignment: start;
                        spacing: 2px;

                        for path_part[i] in current_path_parts: Rectangle {
                            width: txt.preferred-width + 16px;
                            height: 26px;
                            border-radius: 4px;
                            background: ta_path_part.pressed ? #d0d0d0 : (ta_path_part.has-hover ? #e0e0e0 : transparent);
                            txt := Text {
                                text: path-part + " /";
                                color: #333;
                                vertical-alignment: center;
                                horizontal-alignment: center;
                            }

                            ta_path_part := TouchArea {
                                mouse-cursor: pointer;
                                enabled: !root.is_processing;
                                clicked => {
                                    root.path_part_clicked(i);
                                }
                            }
                        }
                    }
                }
            }

            // 2. ä¸­é—´å†…å®¹åŒºåŸŸ
            HorizontalBox {
                spacing: 12px;
                vertical-stretch: 1;

                // å·¦ä¾§ï¼šç›®å½•é€‰æ‹©
                GroupBox {
                    title: "å­æ–‡ä»¶å¤¹";
                    horizontal-stretch: 3;
                    vertical-stretch: 1;

                    Rectangle {
                        background: white;
                        border-color: #ccc;
                        border-width: 1px;
                        ListView {
                            for item in folder_list: Rectangle {
                                height: 32px;
                                width: parent.width;
                                background: ta_folder.pressed ? #cce8ff : (ta_folder.has-hover ? #e6f4ff : transparent);

                                ta_folder := TouchArea {
                                    mouse-cursor: pointer;
                                    enabled: !root.is_processing;
                                    clicked => {
                                        root.folder_clicked(item);
                                    }
                                }

                                Text {
                                    text: "ğŸ“ " + item;
                                    color: #222222;
                                    font-size: 14px;
                                    x: 8px;
                                    vertical-alignment: center;
                                    overflow: elide;
                                    width: parent.width - 16px;
                                }
                            }
                        }
                    }
                }

                // å³ä¾§ï¼šæ‰«æç»“æœ
                GroupBox {
                    title: "æ‰«æç»“æœ (" + scan_results.length + " ä¸ªæ–‡ä»¶)";
                    horizontal-stretch: 5;
                    vertical-stretch: 1;

                    Rectangle {
                        background: white;
                        border-color: #ccc;
                        border-width: 1px;
                        ListView {
                            for item[i] in scan_results: Rectangle {
                                height: 24px;
                                width: parent.width;
                                background: Math.mod(i, 2) == 0 ? #ffffff : #fafafa;
                                Text {
                                    text: item;
                                    color: #555;
                                    font-size: 12px;
                                    x: 8px;
                                    vertical-alignment: center;
                                    overflow: elide;
                                    width: parent.width - 16px;
                                }
                            }
                        }

                        if scan_results.length == 0:Text {
                            text: "æš‚æ— æ‰«æç»“æœ";
                            color: #999;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }

            // 3. åº•éƒ¨æ§åˆ¶æ 
            GroupBox {
                title: "æ§åˆ¶é¢æ¿";
                vertical-stretch: 0;

                HorizontalBox {
                    spacing: 20px;
                    padding: 4px;
                    alignment: center;

                    Text {
                        text: root.status_message;
                        color: #666;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                        // å æ®å·¦ä¾§ç©ºé—´
                    }

                    HorizontalBox {
                        spacing: 16px;
                        CheckBox {
                            text: "*.org~";
                            checked <=> root.org_enabled;
                            enabled: !root.is_processing;
                            toggled => {
                                root.action_text = "æ‰«æ"
                            }
                        }

                        CheckBox {
                            text: "*.html~";
                            checked <=> root.html_enabled;
                            enabled: !root.is_processing;
                            toggled => {
                                root.action_text = "æ‰«æ"
                            }
                        }

                        CheckBox {
                            text: ".DS_Store";
                            checked <=> root.dsstore_enabled;
                            enabled: !root.is_processing;
                            toggled => {
                                root.action_text = "æ‰«æ"
                            }
                        }
                    }

                    Button {
                        text: root.is_processing ? "å¤„ç†ä¸­..." : root.action_text;
                        width: 120px;
                        height: 38px;
                        primary: true;
                        clicked => {
                            if (root.action_text == "æ¸…ç†" && root.scan_results.length > 0) {
                                root.show_confirm_dialog = true;
                            } else {
                                root.action_clicked();
                            }
                        }
                    }
                }
            }
        }

        // --- å›¾å±‚ 2: ç¡®è®¤å¼¹çª— (é®ç½©å±‚) ---
        // åªæœ‰å½“ show_confirm_dialog ä¸º true æ—¶æ‰æ¸²æŸ“
        if root.show_confirm_dialog: Rectangle {
            width: 100%;
            height: 100%;
            background: #00000066; // åŠé€æ˜é»‘è‰²é®ç½©

            // æ‹¦æˆªç‚¹å‡»ï¼Œé˜²æ­¢ç‚¹ç©¿åˆ°åº•éƒ¨ UI
            TouchArea { }

            // å¼¹çª—ä¸»ä½“
            Rectangle {
                width: 320px;
                height: 180px;
                background: white;
                border-radius: 8px;
                // ç®€å•çš„é˜´å½±æ¨¡æ‹Ÿ
                border-width: 1px;
                border-color: #999;

                VerticalBox {
                    padding: 24px;
                    spacing: 20px;
                    alignment: center;

                    // æç¤ºæ–‡å­—
                    Text {
                        text: "è­¦å‘Š!";
                        font-size: 18px;
                        font-weight: 700;
                        color: #d32f2f; // çº¢è‰²è­¦å‘Š
                        horizontal-alignment: center;
                    }

                    Text {
                        text: "ç¡®è®¤è¦æ°¸ä¹…åˆ é™¤è¿™ " + root.scan_results.length + " ä¸ªæ–‡ä»¶å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚";
                        font-size: 14px;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                        color: #333;
                    }

                    // æŒ‰é’®ç»„
                    HorizontalBox {
                        spacing: 20px;
                        alignment: center;

                        Button {
                            text: "å–æ¶ˆ";
                            width: 100px;
                            clicked => {
                                root.show_confirm_dialog = false;
                            }
                        }

                        Button {
                            text: "ç¡®è®¤";
                            width: 100px;
                            primary: true;
                            clicked => {
                                root.show_confirm_dialog = false;
                                // ç”¨æˆ·ç¡®è®¤åï¼Œæ‰çœŸæ­£è°ƒç”¨ Rust é€»è¾‘
                                root.action_clicked();
                            }
                        }
                    }
                }
            }
        }
    }
}
